<!doctype html>
<html lang="en">

<head>
		<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
		<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">


		<link rel="stylesheet" href="css/bootstrap.min.css">

		<script src="js/three.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
		<script src="js/jquery-ui.min.js"></script>
		<script src="js/THREEx.FullScreen.js"></script>
		<script src="js/THREEx.KeyboardState.js"></script>
		<script src="js/leap.min.js"></script>	
		<script src="js/LeapFPControls.js"></script>
		<script src="js/piwmic.js"></script>


		

	<style>
		#container 
			{
				background: #000;
				width: 100%;
				height: 100%;
				margin: 0px;
				overflow: hidden;
			}
		 #hurt 
		 	{
		      background-color: red;
		      display: none;
		      left: 0;
		      opacity: 0.15;
		      width:100%;
		      height:100%;
		      pointer-events: none;
		      position: absolute;
		      top: 0;
		      z-index: 1002;
    		}

    		#health 
    		{
		      bottom: 10px;
		      position: absolute;
		      right: 10px;
		      z-index: 100;
		      
		    }
		    #health h2
		    {
		    	color: #FFCC00;
		    }

		    #subSpace
		    {
		    	position: absolute;
		    	bottom: 40px;
		    	width: 100%;
		    	z-index: 100;
		    	pointer-events: none;

		    }

		     #subs
		    {
		    	margin-right: auto;
		    	margin-left: auto;
		      	pointer-events: none;
		      	text-align:center;
		      z-index: 100;
		      max-width: 70%;
		      
		      }

		    #subs h2
		    {
		    	color:#66FFFF;
		    	size:20px;
		    	font: Lucida Grande, sans-serif;

		    }

	    	#subs .yousay
		    {
		    	color:#FFFF00;
		   	   	font: Lucida Grande, sans-serif;
		   	   	padding-top:30px;

		    }


		    #aim
		    {
		    	pointer-events: none;
		    	position: absolute;
		    	z-index: 100;
		    	width:14%;
		    	left:44.3%;
		    	top:45%;
		    	
		    	
		    }

		    #aimimg
		    {
		    	pointer-events: none;
		    	width:100%;
		    	
		    }
		
		    .span4 h3
		    {
		    	text-align: center;
		    	font-family: "impact";
		    	color: #006699;
		    }
		    #y h3
		    {
		    	font-family: "Comic Sans MS";
		    	color: #006699;

		    }
		    #y
		    {
		    	background-color: #FFEE33;
		    	padding:30px;
		    }
		    #y h4
		    {
		    	text-align: center;
		    	font-family: "impact";
		    	color: red;
		    	
		    }
		    #instructions
		    {
		    	opacity: 0;
		    	
		    }

		    .ins
		    {
		    	padding:5px;
		    	padding-bottom: 15px;
		
		    }

		    #title
		    {
		    	vertical-align: center;
		    	padding-left: 15px;

		    	
		    }


	</style>


		

	</head>
		
	<body>

		<div id="container">
			
		</div>
		<div id="intro">

			
			<div id="title" class="row-fluid">
				<div class="span5">
         			<img src="img/gun.jpg">

		 			
         		</div>
         		<div id="title" class="span6">
					<img  src="img/title.png" width= "100%" >
				</div>
         		
         	</div>
         	<br>
         	<div id="story" class="row-fluid">

	         	<div class="span12" id="y">	
					<h3>Robot-Mutant-Ninja-Zombies from outer space have invaded... you know, a spaceship or spacestation or whatever. <br> <b>Only you can save the world!<b></h3>
					<br>
					<h4 class="center">Click to start</h4>
				</div>
			</div>

			

		</div>
		<div class="row-fluid" id="instructions">
	         		<div class="span4">
	         			<img src="img/inst1.png" >
			 			<h3>1. Aim</h3>
	         		</div>
	         		<div class	="span4">
	         			<img src="img/inst2.png"  >
			 			<h3>2. Move forward</h3>
	         		</div>
	         		<div class="span4">
	         			<img src="img/inst3.png" >
			 			<h3>3. Shoot!</h3>
	         		</div>
	    </div>
				

	 </body>


	 <script>
		//-----------------------LEAP STUF---------

				var firstClick = true;

				var MOVESPEED =100;
				var LOOKSPEED = 0.075;


				runAnim = true;


				// set the scene size
				var WIDTH = window.innerWidth,
				  HEIGHT = window.innerHeight;

				// set some camera attributes
				var VIEW_ANGLE = 45,
				  ASPECT = WIDTH / HEIGHT,
				  NEAR = 0.1,
				  FAR = 10000;

				// get the DOM element to attach to
				// - assume we've got jQuery to hand
				var $container = $('#container');

				var clock = new THREE.Clock();
				var screenfps = 60;

				// create a WebGL renderer, camera
				// and a scene
				var renderer = new THREE.WebGLRenderer();

				var camera =
				  new THREE.PerspectiveCamera(
				    VIEW_ANGLE,
				    ASPECT,
				    NEAR,
				    FAR);

				var scene = new THREE.Scene();

				// add the camera to the scene
				scene.add(camera);

				var aimPos;
				var lasers = [];
				var laserVec = [];
				var laserHit = [];
				var laserMaterial, laserGeo;
				var LeftMarg, TopMarg, LeftMargPercent, TopMargPercent;

				rayDir = new THREE.Vector3(1, 1, 0);
				rayC = new THREE.Raycaster(camera.position,rayDir,1,15);

                //rayDir2 = new THREE.Vector3(1, 1, 0);
				//rayC2 = new THREE.Raycaster(rayDir,rayDir,1,10);
				
				var collisions, collisions2, collisions3, hits, win, projector, splight;

                camera.add(rayC);

                var lavaBall, floor, roof, wall1, wall2, wall3, wall4, wall5, wall6, wall7, door, col1, col2, gate, gate2, controls, buttonArea, lavaBallArea;
                var ballLight;
                var obstacles = [];
                var buttonMove= false;
				var doorOpen = false;
				var pushedButton = false;

                var obi;
                var health = 1000;
                var beinghurt = false;  //to control hurt fadein

                var particleGroup, particleAttributes, particleTexture;
                
				var particleRadiusRange = 15;


                var botMaterial1, botMaterial2, botMaterial3, botMaterial4, botMaterial5, botMaterialRed, bigBotMaterial1, bigBotMaterial2, bigBotMaterial3, obiMaterial1, obiMaterial2;

                var bot_dance_interval = [];
                var botNum = 0;
                var bots = [];
                var botPos1 =[ 
                [1,700,250], 
                [1,600, 250],
                [1,650, 600],
                [1,330, 700],
                [1,130, 660],
                [1,15, 730]
                ];

                var botPos2 =[ 
                [2,525,700], 
                [1,680, 475],
                [1,680, 375],
                [1,680, 275],
                [1,130, 660],
                [1,-75, 560],
                [1,-175, -80],
                [1,0, -20],
                [1,75, -90],
                [1,100, 0],
                [1,30, 150],
                [1, 60,210],
                [1, 95,380],
                [1, 150,450],
                [2, -80,400],
                [1, 560,-75],



                ];

                var chat = [];
                var chatIndex = 0;
                var hadChat1 = false;
                var havingConversation = false;
                var obiWind;

                var targetPosX = window.innerWidth/2;
                var targetPosY = window.innerHeight/2;




		// Initialize and run on document ready
		$(document).ready(function() {

			$('#intro').one('click', function(e) {
				
					e.preventDefault();
					
					$(this).fadeOut();
					$("#instructions").fadeTo("slow",1);
					
				
			});
			$('#instructions').one('click', function(e) {
				e.preventDefault();
				$(this).fadeOut();
				init();
			});
		});





		 var leapvars =
		 {
		 	leapX: 50,
		 	leapY: 50,
		 	leapZ:100,
		 	leapDirX:0,
		 	leapDirY:0,
		 	leapDirZ:0,
		 	handRad:50,
		 	fingerIn: false
		 };
		
		 
		 

		 var previousFrame;


		 

		 


	

	function startLeap() 
	 {
				 // Setup Leap loop with frame callback function
			    var leap = new Leap.Controller({enableGestures: true});
			        var region = new Leap.UI.Region(
			          [0, 150, -100], 
			          [200, 250, 100]
			        );

				leap.addStep(new Leap.UI.Cursor())
				leap.addStep(region.listener({nearThreshold:50}));

				console.log("leap initialized");

				//BIG loop
				leap.loop(function(frame, done) {
		  		// Body of callback function

					//pointer
					if (frame.cursorPosition) {
				      	leap_enabled = true;
				      	leapvars.fingerIn = true;

				        var leapPosition = region.mapToXY(frame.cursorPosition, window.innerWidth, window.innerHeight);

				        leapvars.leapX = (leapPosition[0]);
				        leapvars.leapY = (leapPosition[1]);
				        leapvars.leapZ = leapPosition[2];
				   
				      }
				      else
				      {
				      	leapvars.fingerIn = false;
				      }

				      if(frame.pointables.length > 0)
				      {
				      	
				      	var pointable = frame.pointables[0];

				      	leapvars.leapDirX = -pointable.direction[0];
				      	leapvars.leapDirY = -pointable.direction[1];
				      	leapvars.leapDirZ = pointable.direction[2]; 	 
				      }

				  	var delta = clock.getDelta();
					controls.update(delta);
					//moveAim();
					getCollisionsForward();	
					

				    done();
				});
	}

		
		 //------------------------THREE D STUFF

		 function init()
		 {



					// the camera starts at 0,0,0
					// so pull it back
					camera.position.y = 10;
					camera.position.x = -200;
					camera.position.z = -200;

					//camera.rotation.order = "YXZ";

					// start the renderer
					renderer.setSize(WIDTH, HEIGHT);

					projector = new THREE.Projector(); // A helper class for projecting 2D rays (on the screen) into 3D rays (in the virtual world)				


					// attach the render-supplied DOM element
					// Add the canvas to the document
					renderer.domElement.style.backgroundColor = '#000000'; // easier to see
					document.body.appendChild(renderer.domElement);
					
					THREEx.FullScreen.bindKey({ charCode : 'm'.charCodeAt(0) });


					
					controls = new THREE.LeapFirstPersonControls(camera);
	                controls.movementSpeed = MOVESPEED;
					controls.lookSpeed = LOOKSPEED;
					controls.lookVertical = true; 
					controls.noFly = true;
					controls.leap
					controls.leapForward = false;

					

					// create a point light
					var pointLight1 =
					  new THREE.PointLight(0xFFFFCC);
					pointLight1.position.x = 0;
					pointLight1.position.y = 50;
					pointLight1.position.z = -300;
					pointLight1.castShadow = true;
					pointLight1.intensity = 0.5;
					scene.add(pointLight1);

					// create a point light
					var pointLight2 =
					  new THREE.PointLight(0xFFFFCC);
					pointLight2.position.x = 1000;
					pointLight2.position.y = 20;
					pointLight2.position.z = 700;
					pointLight2.castShadow = true;
					pointLight2.intensity = 0.3;
					scene.add(pointLight2);
					
					// create a point light
					var pointLight3 =
					  new THREE.PointLight(0xFFFFCC);
					pointLight3.position.x = 100;
					pointLight3.position.y = 45;
					pointLight3.position.z = 250;
					//pointLight3.castShadow = true;
					pointLight3.intensity = 0.05;
					scene.add(pointLight3);
					
					//ball light
					ballLight = new THREE.PointLight(0xFF0000);
					ballLight.position.set(-100, 45, 250);
					ballLight.intensity = 0;
					scene.add(ballLight);





					//particles dead bot
					particleTexture = THREE.ImageUtils.loadTexture( 'img/spark.png' );
					particleGroup = new THREE.Object3D();
					particleAttributes = { startSize: [], startPosition: [], randomness: [] };
	
					//OBI
					var obiTexture1 = THREE.ImageUtils.loadTexture( 'img/obi1.png' );
					var obiTexture2 = THREE.ImageUtils.loadTexture( 'img/obi2.png' );
					obiMaterial1 = new THREE.SpriteMaterial( { map: obiTexture1, useScreenCoordinates: false } );
					obiMaterial2 = new THREE.SpriteMaterial( { map: obiTexture2, useScreenCoordinates: false } );
					obi = new THREE.Sprite( obiMaterial1 ); 
						
					obi.position.set(500, 10, -220 );
						obi.scale.set( 30, 35, 1.0 ); 
						obi.talking = false;
						scene.add( obi );




					//ROBOTS
						
					//textures
					var botTexture1 = THREE.ImageUtils.loadTexture( 'img/zrobotanim1.png' );
					var botTexture2 = THREE.ImageUtils.loadTexture( 'img/zrobotanim2.png' );
					var botTexture3 = THREE.ImageUtils.loadTexture( 'img/zrobotanim3.png' );
					var botTexture4 = THREE.ImageUtils.loadTexture( 'img/zrobotanim4.png' );
					var botTexture5 = THREE.ImageUtils.loadTexture( 'img/zrobotanim5.png' );

					var bigBotTexture1 = THREE.ImageUtils.loadTexture( 'img/bigbot1.png' );
					var bigBotTexture2 = THREE.ImageUtils.loadTexture( 'img/bigbot2.png' );
					var bigBotTexture3 = THREE.ImageUtils.loadTexture( 'img/bigbot3.png' );					

					//botanim = new TextureAnimator( botTexture1, 5, 1, 5, 120 ); // texture, #horiz, #vert, #total, duration.
					botMaterialRed = new THREE.SpriteMaterial( { map: botTexture1, useScreenCoordinates: false, color: 0xff0000 } );
					
					botMaterial1 = new THREE.SpriteMaterial( { map: botTexture1, useScreenCoordinates: false } );
					botMaterial2 = new THREE.SpriteMaterial( { map: botTexture2, useScreenCoordinates: false } );
					botMaterial3 = new THREE.SpriteMaterial( { map: botTexture3, useScreenCoordinates: false } );
					botMaterial4 = new THREE.SpriteMaterial( { map: botTexture4, useScreenCoordinates: false } );
					botMaterial5 = new THREE.SpriteMaterial( { map: botTexture5, useScreenCoordinates: false } );


					bigBotMaterial1 = new THREE.SpriteMaterial( { map: bigBotTexture1, useScreenCoordinates: false } );
					bigBotMaterial2 = new THREE.SpriteMaterial( { map: bigBotTexture2, useScreenCoordinates: false } );
					bigBotMaterial3 = new THREE.SpriteMaterial( { map: bigBotTexture3, useScreenCoordinates: false } );



					// Shoot on click
					$(document).click(function(e) {
						e.preventDefault;
						if (e.which === 1) { // Left click only
							piwShoot();
						}
					});



					// Set up the brief red flash that shows when you get hurt
					$('body').append('<div id="hurt"></div>');

					$('body').append('<div id="health"><h2>Health:100</h2></div>');

					$('body').append('<div id="aim"><img id="aimimg" src="img/aim2.png"></div>');

					$('body').append('<div id="subSpace"><div id="subs"></div></div>');
					
					aimPos = document.getElementById("aim");






					//WALL Material 1
					var wallTexture1 = new THREE.ImageUtils.loadTexture( 'img/metal_wall.png' );
					wallTexture1.wrapS = wallTexture1.wrapT = THREE.RepeatWrapping; 
					wallTexture1.repeat.set(5,2);
					var wallMaterial1 = new THREE.MeshLambertMaterial( { map: wallTexture1, side: THREE.DoubleSide} );


					//WALL Material 2
					var wallTexture2 = new THREE.ImageUtils.loadTexture( 'img/tec_wall.png' );
					wallTexture2.wrapS = wallTexture2.wrapT = THREE.RepeatWrapping; 
					wallTexture2.repeat.set(2,2);
					var wallMaterial2 = new THREE.MeshLambertMaterial( { map: wallTexture2} );

					//WALL Material 3
					var wallTexture3 = new THREE.ImageUtils.loadTexture( 'img/door.png' );
					wallTexture3.wrapS = wallTexture3.wrapT = THREE.RepeatWrapping; 
					wallTexture3.repeat.set(4,1);
					var wallMaterial3 = new THREE.MeshLambertMaterial( { map: wallTexture3} );

					//WALL Material 3
					var wallTexture3b = new THREE.ImageUtils.loadTexture( 'img/door.jpg' );
					wallTexture3b.wrapS = wallTexture3b.wrapT = THREE.RepeatWrapping; 
					wallTexture3b.repeat.set(1,1);
					var wallMaterial3b = new THREE.MeshLambertMaterial( { map: wallTexture3b} );


					//WALL Material 4
					var wallTexture4 = new THREE.ImageUtils.loadTexture( 'img/cables.png' );
					wallTexture4.wrapS = wallTexture4.wrapT = THREE.RepeatWrapping; 
					wallTexture4.repeat.set(5,1);
					var wallMaterial4 = new THREE.MeshLambertMaterial( { map: wallTexture4, side:THREE.DoubleSide} );

					//WALL Material 5
					var wallTexture5 = new THREE.ImageUtils.loadTexture( 'img/metal.png' );
					wallTexture5.wrapS = wallTexture5.wrapT = THREE.RepeatWrapping; 
					wallTexture5.repeat.set(10,2);
					var wallMaterial5 = new THREE.MeshLambertMaterial( { map: wallTexture5, side:THREE.DoubleSide} );

					//WALL Material 6
					var wallTexture6 = new THREE.ImageUtils.loadTexture( 'img/panel.jpg' );
					wallTexture6.wrapS = wallTexture6.wrapT = THREE.RepeatWrapping; 
					wallTexture6.repeat.set(1,1);
					var wallMaterial6 = new THREE.MeshLambertMaterial( { map: wallTexture6, color: 0xff0000} );

					//FLOOR material1
					var floorTexture = new THREE.ImageUtils.loadTexture( 'img/scrn3.gif' );
					floorTexture.wrapS = floorTexture.wrapT = THREE.RepeatWrapping; 
					floorTexture.repeat.set(60,60);
					var floorMaterial = new THREE.MeshLambertMaterial( { map: floorTexture, color: 0xCCCC99} );


					//Floor material 2
					var floorTexture2 = new THREE.ImageUtils.loadTexture( 'img/walkway.jpg' );
					floorTexture2.wrapS = floorTexture2.wrapT = THREE.RepeatWrapping; 
					floorTexture2.repeat.set(25,3);
					var floorMaterial2 = new THREE.MeshLambertMaterial( { map: floorTexture2} );

					//Roof material 1
					var roofTexture = new THREE.ImageUtils.loadTexture( 'img/wall3.jpg' );
					roofTexture.wrapS = roofTexture.wrapT = THREE.RepeatWrapping; 
					roofTexture.repeat.set(20,20);
					var roofMaterial = new THREE.MeshLambertMaterial( { map: roofTexture} );

					//Roof material 2
					var roofTexture2 = new THREE.ImageUtils.loadTexture( 'img/fan_roof.jpg' );
					roofTexture2.wrapS = roofTexture2.wrapT = THREE.RepeatWrapping; 
					roofTexture2.repeat.set(20,3);
					var roofMaterial2 = new THREE.MeshLambertMaterial( { map: roofTexture2} );

					//invisible material
					var invisibleMaterial = new THREE.MeshLambertMaterial({color:0xff0000, transparent: true, opacity:0});


					//FLOOR main
					var floorGeometry = new THREE.PlaneGeometry(1000, 1000);
					floor = new THREE.Mesh(floorGeometry, floorMaterial);
					floor.position.y = -10;
					floor.position.z = 250;
					floor.position.x = 250;
					floor.rotation.x = Math.PI *1.5;
					scene.add(floor);

					//ROOF main
					var roofGeometry = new THREE.PlaneGeometry(1000, 1000);
					roof = new THREE.Mesh(roofGeometry, roofMaterial);
					roof.position.y = 100;
					roof.position.z = 250;
					roof.position.x = 250;
					roof.rotation.x = Math.PI / 2;			
					scene.add(roof);

					//ROOF pasillo
					var roof2Geometry = new THREE.CubeGeometry(800, 10, 100);
					roof2 = new THREE.Mesh(roof2Geometry, roofMaterial2);
					roof2.position.y = 83;
					roof2.position.z = 700;
					roof2.position.x = 150;	
					scene.add(roof2);

					//FLOOR pasillo
					var floor2Geometry = new THREE.CubeGeometry(800, 10, 100);
					floor2 = new THREE.Mesh(floor2Geometry, floorMaterial2);
					floor2.position.y = -12;
					floor2.position.z = 700;
					floor2.position.x = 150;	
					scene.add(floor2);



					//COL1
					var col1Geometry = new THREE.CylinderGeometry(35, 20, 130,14,1,1);
					col1 = new THREE.Mesh(col1Geometry, wallMaterial2);
					col1.position.x = 0;
					col1.position.y = 50;
					col1.position.z = -180;
					scene.add(col1);

					//COL2
					var col2Geometry = new THREE.CylinderGeometry(35, 20, 130,14,1,1);
					col2 = new THREE.Mesh(col2Geometry, wallMaterial2);
					col2.position.x = 400;
					col2.position.y = 50;
					col2.position.z = -220;
					scene.add(col2);

					//GATE1
					var gate1Geometry = new THREE.TorusGeometry(90, 40, 10,6,Math.PI*2);
					gate1 = new THREE.Mesh(gate1Geometry, wallMaterial1);
					gate1.position.x = 650;
					gate1.position.y = 40;
					gate1.position.z = -130;
					scene.add(gate1);

					//GATE2
					var gate2Geometry = new THREE.TorusGeometry(85, 40, 10,6,Math.PI*2);
					gate2 = new THREE.Mesh(gate2Geometry, wallMaterial1);
					gate2.position.x = 530;
					gate2.position.y = 35;
					gate2.position.z = 700;
					gate2.rotation.y = Math.PI / 2;
					scene.add(gate2);




					//WALL1
					var wall1Geometry = new THREE.CubeGeometry(800, 130, 10);
					wall1 = new THREE.Mesh(wall1Geometry, wallMaterial5);
					wall1.position.x = 150;
					wall1.position.y = 50;
					wall1.position.z = -150;
					scene.add(wall1);

					//WALL2
					var wall2Geometry = new THREE.CubeGeometry(800, 130, 10);
					wall2 = new THREE.Mesh(wall2Geometry, wallMaterial4);
					wall2.position.x = 150;
					wall2.position.y = 50;
					wall2.position.z = 650;
					scene.add(wall2);

					//WALL3
					var wall3Geometry = new THREE.CubeGeometry(40, 130, 800);
					wall3 = new THREE.Mesh(wall3Geometry, wallMaterial3);
					wall3.position.x = 530;
					wall3.position.y = 50;
					wall3.position.z = 250;
					scene.add(wall3);



					//WALL4
					var wall4Geometry = new THREE.PlaneGeometry(1000, 130, 1, 1);
					wall4 = new THREE.Mesh(wall4Geometry, wallMaterial5);
					wall4.position.x = 750;
					wall4.position.y = 50;
					wall4.position.z = 250;
					wall4.rotation.y = Math.PI / 2;
					scene.add(wall4);

					//WALL5
					var wall5Geometry = new THREE.PlaneGeometry(1000, 130, 1, 1);
					wall5 = new THREE.Mesh(wall5Geometry, wallMaterial4);
					wall5.position.x = 250;
					wall5.position.y = 50;
					wall5.position.z = 750;
					scene.add(wall5);

					//WALL6
					var wall6Geometry = new THREE.PlaneGeometry(1000, 130, 1, 1);
					wall6 = new THREE.Mesh(wall6Geometry, wallMaterial1);
					wall6.position.x = 250;
					wall6.position.y = 50;
					wall6.position.z = -250;
					//wall6.rotation.z = Math.PI / 4;
					scene.add(wall6);

					//WALL7
					var wall7Geometry = new THREE.CubeGeometry(10, 130, 100);
					wall7 = new THREE.Mesh(wall7Geometry, wallMaterial1);
					wall7.position.x = -230;
					wall7.position.y = 50;
					wall7.position.z = 700;
					scene.add(wall7);

					//Button
					var buttonGeometry = new THREE.CubeGeometry(30,7,7);
					button = new THREE.Mesh(buttonGeometry, wallMaterial6);
					button.position.x = -220;
					button.position.y = 10;
					button.position.z = 700;
					scene.add(button);

					//buttonArea
					var buttonAreaGeometry = new THREE.CubeGeometry(60,100,100);
					buttonArea = new THREE.Mesh(buttonAreaGeometry, invisibleMaterial);
					buttonArea.position.x = -220;
					buttonArea.position.y = 10;
					buttonArea.position.z = 700;
					scene.add(buttonArea);

					//skywall
					var skywallGeometry = new THREE.CubeGeometry(10, 130, 1000);
					skywall = new THREE.Mesh(skywallGeometry, invisibleMaterial);
					skywall.position.x = -250;
					skywall.position.y = 50;
					skywall.position.z = 250;
					scene.add(skywall);

										// set up the sphere vars
					var radius = 40,
					    segments = 16,
					    rings = 16;


					// basic lava ball
					var lavaTexture = THREE.ImageUtils.loadTexture( 'img/lava.jpg' );
					var lavaMaterial = new THREE.MeshBasicMaterial( { map: lavaTexture } );
					lavaBall = new THREE.Mesh(  new THREE.SphereGeometry(
					    radius,
					    segments,
					    rings), lavaMaterial );
					lavaBall.position.set(-100, 45, 250);
					scene.add( lavaBall );	

					//lava ball area
					var lavaBallGeometry = new THREE.CubeGeometry(45,45,45);
					lavaBallArea = new THREE.Mesh(lavaBallGeometry, invisibleMaterial);
					lavaBallArea.position.set(-100, 45, 250);
					scene.add(lavaBallArea);	

					// SUPER SIMPLE GLOW EFFECT
					// use sprite because it appears the same from all angles
					var spriteMaterial = new THREE.SpriteMaterial( 
					{ 
						map: new THREE.ImageUtils.loadTexture( 'img/glow.png' ), 
						useScreenCoordinates: false, alignment: THREE.SpriteAlignment.center, color: 0x0000ff, transparent: false, blending: THREE.AdditiveBlending
					});
					var glow = new THREE.Sprite( spriteMaterial );
					glow.scale.set(130, 130, 1.0);
					lavaBall.add(glow); // this centers the glow at the mesh

					


					//PARA CREAR LASERS
					laserMaterial = new THREE.MeshBasicMaterial({color: 0xFF1100});
					laserGeo = new THREE.CubeGeometry(0.5, 0.5, 10);
					//laserGeo = new THREE.CylinderGeometry(1, 0.5, 10, 6,1,false);

					//CIELO
					var skyGeometry = new THREE.CubeGeometry( 4000, 4000, 4000 );	
					var skyTexture = new THREE.ImageUtils.loadTexture( "img/sky.jpg" );
					var skyMaterial = new THREE.MeshBasicMaterial( { map: skyTexture, side:THREE.DoubleSide } );
					var skyBox = new THREE.Mesh( skyGeometry, skyMaterial );
					skyBox.position.y=1000;
					skyBox.position.z= 1000;
					scene.add( skyBox );

					
					obstacles.push(wall1, wall2, wall3, wall4, wall5, wall6, wall7, col1, col2, skyBox, gate1, gate2, skywall);

					
					//LIGHTS
					var loader = new THREE.ObjectLoader();

					// loader.load( "lights/light1.json", function (object) 
					// {	
	    // 				scene.add(object);
	    // 				console.log("added light");
					// });
					loader.load( "lights/light2.json", function (object) 
					{	
						splight = object;
	    				scene.add(object);
					});
					loader.load( "lights/light2target.json", function (object) 
					{	
	    				splight.add(object);
					});
				

					
					animate();
					startLeap();


				}


				function animate()
				{
					if (runAnim) 
					{
						requestAnimationFrame(animate);
					}
					render();		

				}

			




				
				function onWindowResize() 
				{

                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();

                    renderer.setSize( window.innerWidth, window.innerHeight );

                }


				

				function moveAim()
				{
					//$("#aim").left = leapvars.leapDirX;
					
					//var aimLeftMarg = window.innerWidth/100*(43 - leapvars.leapDirX*10);
					LeftMarg = Math.round((43 - leapvars.leapDirX*10)*100)/100;
					LeftMargPercent = LeftMarg.toString().concat("%");

					TopMarg = Math.round((45 + leapvars.leapDirY*10)*100)/100;
					TopMargPercent = TopMarg.toString().concat("%");


					aimPos.style.left = LeftMargPercent;
					aimPos.style.top =  TopMargPercent;
					

				}

				function getCollisionsForward()
				{
					//GET COLLISIONS
					//rayC.set(camera.position, camera.rotation);
					rayDir.applyQuaternion( camera.quaternion );
					rayC.set(camera.position,rayDir);

					if (buttonMove == false && pushedButton == false)
					{
						var buttonPush = rayC.intersectObject(buttonArea);
						if(buttonPush.length>0)
						{
							pushedButton = true;
							buttonMove= true;
							doorOpen = true;
							obi.position.set(300,10,200);
							addBots(botPos2);
							//console.log("pushing button");
						}
					}

					collisions = rayC.intersectObjects(obstacles, true);
					if(collisions.length>0 && havingConversation == false)
					{
						camera.translateZ(1.1);
						camera.position.y = 10;
						console.log("canÂ´t walk that way");	
					}
					else
					{
						if(leapvars.fingerIn)
						{
							if(leapvars.leapZ<0)
							{
								camera.translateZ(-1);
								camera.position.y = 10;
								//console.log("X: " + camera.position.x + " Z: " + camera.position.z); 
							}
						}
					}
				}


				function piwShoot()
				{
					//console.log("PIW");

					var tiro = new THREE.Mesh(laserGeo, laserMaterial);
					
					
					tiro.rotation.set(camera.rotation.x,camera.rotation.y, camera.rotation.z);
					tiro.position.set(camera.position.x, camera.position.y * 0.6, camera.position.z);
						//x = Math.PI *1.5;

					//GLOW
					var lasglow = new THREE.PointLight(0xff0000 ,1 );
					lasglow.distance = 200;
					lasglow.width = 60;
					lasglow.height = 60;
					//lasglow.castShadow= true;
					//lasglow.shadowCameraFar = 400;
					tiro.add(lasglow);

					
					
					//FOR MOVING AIM
					var vector = new THREE.Vector3((LeftMarg+7-50)*window.innerWidth, (50-TopMarg+5)*window.innerHeight, 1);
					// var vector = new THREE.Vector3((LeftMarg+7)*window.innerWidth, (window.innerHeight- (TopMarg+5)*window.innerHeight), 1);
					projector.unprojectVector(vector, camera);
					tiro.ray = new THREE.Ray(
							camera.position,
							vector.sub(camera.position).normalize()
					);
					
					tiro.owner = camera;
					lasers.push(tiro);
					scene.add(tiro);

					var laserDir = new THREE.Vector3(0,1,0);
 					laserDir.applyQuaternion(tiro.quaternion);
 					var rayClaser = new THREE.Raycaster(tiro.position, laserDir, 0.5, 15);
					laserVec.push(laserDir);
					laserHit.push(rayClaser);
					

 
					return tiro;
		
				}


			
				function render()
				{	

					var xvec = new THREE.Vector3(0,1,0);
					lavaBall.rotateOnAxis(xvec,0.01);


				
					
					// Update lasers. Walk backwards through thise list so we can remove items
					for (var i = lasers.length-1; i >= 0; i--) 
					{
						if(lasers[i].position.x>2000 || lasers[i].position.x<-2000 || lasers[i].position.z>2000 || lasers[i].position.z<-2000)
						{
							scene.remove(lasers[i]);
							lasers.splice(i, 1);
							laserVec.splice(i, 1);
							laserHit.splice(i, 1);
						}
						else
						{

							//move forward!
							lasers[i].translateZ(-12);

							laserHit[i].set(lasers[i].position, laserVec[i]);

							collisions3 = laserHit[i].intersectObjects(obstacles,true).length;
							hits = laserHit[i].intersectObjects(bots);
							win = laserHit[i].intersectObject(lavaBallArea);


							if(collisions3>0)
							{
								scene.remove(lasers[i]);
								lasers.splice(i, 1);
								laserVec.splice(i, 1);
								laserHit.splice(i, 1);
								
							}
							if(hits.length>0)
							{
								
								
								//remove laser
								scene.remove(lasers[i]);
								lasers.splice(i, 1);
								laserVec.splice(i, 1);
								laserHit.splice(i, 1);

								//kill bot
								var killedBot = bots.indexOf(hits[0].object);
								console.log("HIT A BOT!! " +  killedBot );
								bots[killedBot].dying = true;
								botSparks(bots[killedBot], 150);
								//botDie(killedBot);
								var die = setTimeout( function(){botDie(killedBot)},2000);
							}
							if(win.length>0)
							{
								//alert("Yey, you won!");
								var end = setInterval (apocalipse,100);
								var mySparks =  setTimeout( function(){botSparks(lavaBall, 500)},4000);
								var oops =  setTimeout( function(){document.getElementById("subs").innerHTML = "<h2> hmm, my bad</h2>";},1000);
								var end =  setTimeout( function(){alert("thanks for playing!")},20000);


								


							}
						}
					}

					hurtYou();
					walkToYou();

					sparkUpdate();

					if (buttonMove)
					{
						if (button.position.x < -228)
							{
								buttonMove = false;
								console.log("done pushing");
							}
						button.position.x -=0.2;
					}

					if (doorOpen)
					{
						if (wall3.position.z < -300)
							{
								doorOpen = false;
							}
						wall3.position.z -=0.1;
					}

					if (distance2D(obi.position.x, obi.position.z, camera.position.x, camera.position.z) < 150  && havingConversation== false) 
						{
							//conversationMode
							if (chatIndex<1 && hadChat1 == false)
							{
								havingConversation = true;
								conversation(1);
								addBots(botPos1);
								console.log("chat 1 started");
							}
							else if (chatIndex>25 && hadChat1 == true && pushedButton == true)
							{
								havingConversation = true;
								chatIndex = 31	;
								conversation(2);
								console.log("chat 2 started");
							}
							
						}

					//loop back and run this func again
					renderer.render(scene, camera);
					// place the rAF *before* the render() to assure as close to 60fps with the setTimeout fallback.
				}

				function apocalipse()
				{
					ballLight.intensity += 0.1;
				}

				function conversation(conv)
				{
					//chat = [];
					//chatIndex = 0;
					if(conv == 1)
					{
						hadChat1 = true;

						chat.push(["I knew you would come",1000,1]);
						chat.push(["my senses told me so", 1000,1]);
						chat.push(["who are you?", 2000,2]);
						chat.push(["you are the one that will save us",3000,1]);
						chat.push(["I know who I am! I asked who YOU are!",2000,2]);
						chat.push(["You already know",2000,1]);
						chat.push(["You also already know how to use your true power",2000,1]);
						chat.push(["All you need to do is say PEEW! Say it out loud and high pitched!",6000,1]);
						chat.push(["That is soooo gay!",3000,2]);
						chat.push(["SAY IT! Say it or we will all perish!",2000,1]);
						chat.push(["Do I reaaaly have to?",3000,2]);
						chat.push(["Come on, say it like a MAN!",2000,1]);
						chat.push(["By the way... maybe you need to allow your browser permissions to use the mic",5000,1]);

						chat.push(["Good! now you are ready to take on the army of Mutant Kung-Foo robot zombies!",5000,1]);
						chat.push(["Werent they Mutant Ninja robot zombies?",3500,2]);
						chat.push(["That is what I said",1500,1]);
						chat.push(["Nono, you said Kung-Foo!",1500,2]);
						chat.push(["Right",1000,1]);
						chat.push(["But they are Ninja!",1500,2]);
						chat.push(["I am not following",1500,1]);
						chat.push(["Kung-foo and Ninjitsu are two different martial arts",5000,2]);
						chat.push(["This is the future... the lines are pretty blurry by now. They are the same",5000,1]);
						chat.push(["Hmm well it would still be historically incorrect... some people might even feel offended by",4000,2]);
						chat.push(["THE WORLD IS IN PERIL! GO, FOR CHRIST SAKE! GO!",5000,1]);
						chat.push(["Arent you coming with me? My life will be in danger and you could be of help",4000,2]);
						chat.push(["No",1000,1]);
						chat.push(["I need you!",2000,2]);
						chat.push(["Mind your own business",4000,1]);
						chat.push(["Go!",4000,1]);

						chat.push([" ",3000,1]);
						chat.push([" ",3000,3]);
					}
					else if (conv == 2)
					{
						chat.push(["Well done!",1000,1]);
						chat.push(["Now you must destroy that round thing there!",4000,1]);
						chat.push(["Why what is it?",2000,2]);
						chat.push(["How the hell would I know??",2000,1]);
						chat.push(["But it is there for some reason, and you can shoot...  it makes sense",6000,1]);
						chat.push(["Hey by the way, I wanted to ask...",5000,2]);
						chat.push(["How can a robot also be a mutant? It has no genes to mutate...",6000,2]);
						chat.push(["And on that matter, how can a zombi be ninja? It hardly has any control over its body",6000,2]);
						chat.push(["You ask way too many questions...",4000,1]);
						chat.push(["Just shoot already!",5000,1]);
						chat.push(["Whatever that thing is.. I bet it will look cool when it blows up!",6000,1]);
						chat.push(["By the way, shoot it a bunch of times because it sometimes is a bit glitchy!",5000,1]);
						
						chat.push(["Sure the explosion will not kill us?",6000,2]);
						chat.push(["Yeah... what a pussy",6000,1]);
						chat.push([" ",3000,1]);

					}

					//stay still
					//chatIndex = 0;
					obiWind = setInterval(obiDance, 500);
					speak();
				}

				function speak()
				{	
					var phrase = chat[chatIndex];

					if (phrase[2] ==1)
					{
						document.getElementById("subs").innerHTML = "<h2>" + phrase[0] +"</h2>";
					}
					else if (phrase[2] ==2)
					{
						document.getElementById("subs").innerHTML = '<h2 class="yousay">' + phrase[0] +"</h2>";
						
					}	
					else if (phrase[2] ==3)
					{
						//clearInterval(obiWind);
						
						havingConversation = false;
						return false;
					}

					chatIndex += 1;
					setTimeout(speak, phrase[1]);

				}

				function obiDance()
				{
					if (obi.material == obiMaterial1)
					{
						obi.material = obiMaterial2;
					}
					else
					{
						obi.material = obiMaterial1;
					}
				}

				function addBots(botPos)
				{
					//positions
					for (var i = 0; i < botPos.length; i++)
					{
						thisBot = botPos[i];
						var posX = thisBot[1];
						var posZ = thisBot[2];



						if(thisBot[0] ==1) //normal
						{
							var myBot = new THREE.Sprite( botMaterial1 );
							myBot.scale.set( 30, 35, 1.0 );
							//dance
							var firstStep = Math.floor(Math.random()*5)+1;
							botDance(myBot, firstStep);
						}
						else if (thisBot[0] ==2) //big bot
						{
							var myBot = new THREE.Sprite( bigBotMaterial1 ); 
							myBot.scale.set( 50, 50, 1.0 ); 
							console.log("adding big bot");
							//dance
							var firstStep = Math.floor(Math.random()*3)+1;
							bigBotDance(myBot, firstStep);
						}
						
						
						myBot.botType = thisBot[0];
						myBot.position.set( posX, 10, posZ );
						
						myBot.botVec = new THREE.Vector3(0,0,1);
						myBot.crash = new THREE.Raycaster(myBot.position, myBot.botVec, 0.5, 10);
						myBot.dying = false;
						
						bots.push(myBot);
						scene.add( myBot );
					}
					console.log("adding bots: " + botPos.length);
				}


				function botDie (killedBot) 
				{
					//cool bot animation
					scene.remove(bots[killedBot]);
					bots.splice(killedBot,1);
					var noSparks = setTimeout( function(){scene.remove(particleGroup)},700);
					console.log("removing bot " + killedBot + " " + bots.length + " bots remaining");
					
				}
				function botSparks(killedBot, totalParticles)
				{
					for( var i = 0; i < totalParticles; i++ ) 
					{
					    var spriteMaterial = new THREE.SpriteMaterial( { map: particleTexture, useScreenCoordinates: false, color: 0xffffff } );
						
						var sprite = new THREE.Sprite( spriteMaterial );
						sprite.scale.set( 7, 7, 1.0 ); // imageWidth, imageHeight
						sprite.position.set( Math.random() - 0.5, Math.random() - 0.5, Math.random() - 0.5 );
						// for a spherical shell:
						sprite.position.setLength( particleRadiusRange * (Math.random() * 0.2 + 0.8) );
						
						// sprite.color.setRGB( Math.random(),  Math.random(),  Math.random() ); 
						sprite.material.color.setHSL( Math.random()*4/10, 0.9, 0.85 ); 
						
						// sprite.opacity = 0.80; // translucent particles
						sprite.material.blending = THREE.AdditiveBlending; // "glowing" particles
						
						particleGroup.add( sprite );
						// add variable qualities to arrays, if they need to be accessed later
						particleAttributes.startPosition.push( sprite.position.clone() );
						particleAttributes.randomness.push( Math.random() );
					}
					particleGroup.position.x = killedBot.position.x;
					particleGroup.position.z = killedBot.position.z;
					particleGroup.position.y = 12;
					scene.add( particleGroup );

				}

				function sparkUpdate()
				{
					var time = 4 * clock.getElapsedTime();
	
					for ( var c = 0; c < particleGroup.children.length; c ++ ) 
					{
						var sprite = particleGroup.children[ c ];

						// particle wiggle
						// var wiggleScale = 2;
						// sprite.position.x += wiggleScale * (Math.random() - 0.5);
						// sprite.position.y += wiggleScale * (Math.random() - 0.5);
						// sprite.position.z += wiggleScale * (Math.random() - 0.5);
						
						// pulse away/towards center
						// individual rates of movement
						var a = particleAttributes.randomness[c] + 1;
						var pulseFactor = Math.sin(a * time) * 0.1 + 0.9;
						sprite.position.x = particleAttributes.startPosition[c].x * pulseFactor;
						sprite.position.y = particleAttributes.startPosition[c].y * pulseFactor;
						sprite.position.z = particleAttributes.startPosition[c].z * pulseFactor;	
					}

					// rotate the entire group
					// particleGroup.rotation.x = time * 0.5;
					particleGroup.rotation.y = time * 0.75;
					// particleGroup.rotation.z = time * 1.0;

				}

				function hurtYou()
				{
					for (var i = 0; i < bots.length; i++)
					{
						if (distance2D(bots[i].position.x, bots[i].position.z, camera.position.x, camera.position.z) < 25 && bots[i].dying == false) 
						{
							
							health -= 2;
							if (beinghurt == false)
							{
								beingHurt = true;

								var wait = setTimeout(function(){ beingHurt = false;}, 1300);
								$('#hurt').fadeIn(75);
								// ... hurt the player ...
								$('#hurt').fadeOut(150);
								
							}
							var myHealth = Math.floor(health/10);
							document.getElementById("health").innerHTML = "<h2>Health: " + myHealth + "</h2>";
							if(myHealth < 0)
							{
								document.getElementById("subs").innerHTML = "<h2> You really suck at this</h2>";

							}
						}
					}
				}

				function walkToYou()
				{
					//getDir
					//update their direction
					for (var i = 0; i < bots.length; i++)
					{ 
						if(!bots[i].dying)
						{
							//lookatyou
							bots[i].lookAt(camera.position);

							bots[i].botVec.applyQuaternion(bots[i].quaternion);

							bots[i].crash.set(bots[i].position, bots[i].botVec);

							collisions2 = bots[i].crash.intersectObjects(obstacles,true).length;

							if(collisions2>0)
							{
								bots[i].translateZ(-5);
							}
							else if (collisions2 == 0)
							{
								//walk 
							 	bots[i].translateZ(0.3);
							}
						}
					}
				}

				function botDance(bot, step)
				{
					if (!bot.dying)
					{
						if( step < 5)
						{
							nextStep = step +1;
						}
						else
						{
							nextStep = 1;
						}
							
						var mat = "botMaterial";
						bot.material = eval(mat.concat(nextStep)); //weird workarround because if not it used the object mat
						var delay =	Math.floor((Math.random()*50)+400);
						var runAgain = setTimeout(function(){botDance(bot, nextStep)},delay );
					}
					else
					{
						bot.material = botMaterialRed;
					}
				}

				function bigBotDance(bot, step)
				{
				
					if( step < 3)
					{
						nextStep = step +1;
					}
					else
					{
						nextStep = 1;
					}
						
					var mat = "bigBotMaterial";
					bot.material = eval(mat.concat(nextStep)); //weird workarround because if not it used the object mat
					var delay =	400;
					var runAgain = setTimeout(function(){bigBotDance(bot, nextStep)},delay );
					
				}

				

				function distance2D(aX, aZ, bX, bZ)
				{
					var dx = Math.abs(aX-bX);
					var dy = Math.abs(aZ-bZ);
					return Math.sqrt(Math.pow(dx,2)+Math.pow(dy,2));
				}

		 </script>

</html>